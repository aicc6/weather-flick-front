import { useState, useEffect, useRef } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Calendar } from '@/components/ui/calendar'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { Badge } from '@/components/ui/badge'
import { Checkbox } from '@/components/ui/checkbox'
import { CalendarIcon, MapPin } from '@/components/icons'
import { format } from 'date-fns'
import { ko } from 'date-fns/locale'
import { Loader } from '@googlemaps/js-api-loader'

const themes = [
  { id: 'relax', label: 'Ìú¥Ïñë', icon: 'üèñÔ∏è' },
  { id: 'activity', label: 'Ïï°Ìã∞ÎπÑÌã∞', icon: 'üèÉ‚Äç‚ôÇÔ∏è' },
  { id: 'camping', label: 'Ï∫†Ìïë', icon: '‚õ∫' },
  { id: 'healing', label: 'ÌûêÎßÅ', icon: 'üßò‚Äç‚ôÄÔ∏è' },
]

const weatherConditions = [
  { id: 'exclude-rain', label: 'Í∞ïÏàòÎüâ ÎßéÏúºÎ©¥ Ï†úÏô∏' },
  { id: 'low-uv', label: 'ÏûêÏô∏ÏÑ† ÎÇÆÏùÄ Í≥≥ Ï∂îÏ≤ú' },
]

// ÌïúÍµ≠ Ï£ºÏöî Ïó¨ÌñâÏßÄ Î™©Î°ù (Google API ÎåÄÏïà)
const POPULAR_DESTINATIONS = [
  { name: 'Î∂ÄÏÇ∞', fullName: 'Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú', description: 'Ìï¥Ïö¥ÎåÄ, Í¥ëÏïàÎ¶¨ Ìï¥Î≥Ä' },
  {
    name: 'Ï†úÏ£ºÎèÑ',
    fullName: 'Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ',
    description: 'ÌïúÎùºÏÇ∞, ÏÑ±ÏÇ∞ÏùºÏ∂úÎ¥â',
  },
  { name: 'Í∞ïÎ¶â', fullName: 'Í∞ïÏõêÎèÑ Í∞ïÎ¶âÏãú', description: 'Í≤ΩÌè¨ÎåÄ, ÏïàÎ™©Ìï¥Î≥Ä' },
  {
    name: 'Ï†ÑÏ£º',
    fullName: 'Ï†ÑÎùºÎ∂ÅÎèÑ Ï†ÑÏ£ºÏãú',
    description: 'ÌïúÏò•ÎßàÏùÑ, Ï†ÑÏ£ºÎπÑÎπîÎ∞•',
  },
  { name: 'Í≤ΩÏ£º', fullName: 'Í≤ΩÏÉÅÎ∂ÅÎèÑ Í≤ΩÏ£ºÏãú', description: 'Î∂àÍµ≠ÏÇ¨, Ï≤®ÏÑ±ÎåÄ' },
  {
    name: 'Ïó¨Ïàò',
    fullName: 'Ï†ÑÎùºÎÇ®ÎèÑ Ïó¨ÏàòÏãú',
    description: 'Ïó¨ÏàòÎ∞§Î∞îÎã§, Ïò§ÎèôÎèÑ',
  },
  { name: 'ÏÜçÏ¥à', fullName: 'Í∞ïÏõêÎèÑ ÏÜçÏ¥àÏãú', description: 'ÏÑ§ÏïÖÏÇ∞, ÏÜçÏ¥àÌï¥Î≥Ä' },
  {
    name: 'ÏàúÏ≤ú',
    fullName: 'Ï†ÑÎùºÎÇ®ÎèÑ ÏàúÏ≤úÏãú',
    description: 'ÏàúÏ≤úÎßå, ÎÇôÏïàÏùçÏÑ±',
  },
  {
    name: 'ÏïàÎèô',
    fullName: 'Í≤ΩÏÉÅÎ∂ÅÎèÑ ÏïàÎèôÏãú',
    description: 'ÌïòÌöåÎßàÏùÑ, ÏïàÎèôÏ∞úÎã≠',
  },
  {
    name: 'Îã¥Ïñë',
    fullName: 'Ï†ÑÎùºÎÇ®ÎèÑ Îã¥ÏñëÍµ∞',
    description: 'Ï£ΩÎÖπÏõê, Î©îÌÉÄÏÑ∏ÏøºÏù¥ÏïÑÍ∏∏',
  },
  { name: 'ÏÑúÏö∏', fullName: 'ÏÑúÏö∏ÌäπÎ≥ÑÏãú', description: 'Í≤ΩÎ≥µÍ∂Å, Î™ÖÎèô, ÌôçÎåÄ' },
  {
    name: 'Ïù∏Ï≤ú',
    fullName: 'Ïù∏Ï≤úÍ¥ëÏó≠Ïãú',
    description: 'Ï∞®Ïù¥ÎÇòÌÉÄÏö¥, ÏùÑÏôïÎ¶¨Ìï¥Î≥Ä',
  },
  { name: 'ÎåÄÍµ¨', fullName: 'ÎåÄÍµ¨Í¥ëÏó≠Ïãú', description: 'ÌåîÍ≥µÏÇ∞, ÎèôÏÑ±Î°ú' },
  { name: 'Í¥ëÏ£º', fullName: 'Í¥ëÏ£ºÍ¥ëÏó≠Ïãú', description: 'Î¨¥Îì±ÏÇ∞, ÏñëÎ¶ºÎèô' },
  {
    name: 'ÎåÄÏ†Ñ',
    fullName: 'ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú',
    description: 'Ïú†ÏÑ±Ïò®Ï≤ú, ÎåÄÏ†ÑÏóëÏä§Ìè¨Í≥ºÌïôÍ≥µÏõê',
  },
]

export default function PlanForm({ onSubmit }) {
  const [formData, setFormData] = useState({
    destination: '',
    startDate: null,
    endDate: null,
    theme: '',
    weatherConditions: [],
  })
  const [googleApiKey, setGoogleApiKey] = useState(null)
  const [isLoadingApiKey, setIsLoadingApiKey] = useState(true)
  const [isGoogleApiLoaded, setIsGoogleApiLoaded] = useState(false)
  const [apiKeyError, setApiKeyError] = useState(null)
  const [suggestions, setSuggestions] = useState([])
  const [showSuggestions, setShowSuggestions] = useState(false)
  const [useGoogleApi, setUseGoogleApi] = useState(true)
  const [startDateOpen, setStartDateOpen] = useState(false)
  const [endDateOpen, setEndDateOpen] = useState(false)
  const inputRef = useRef(null)
  const autocompleteRef = useRef(null)

  // Î∞±ÏóîÎìúÏóêÏÑú Google API Key Î∞õÏïÑÏò§Í∏∞
  useEffect(() => {
    const fetchGoogleApiKey = async () => {
      try {
        console.log('Fetching Google API key from backend...')
        const response = await fetch('/api/config/google-key')
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        const data = await response.json()
        console.log('Google API key received:', data.googleApiKey)

        // Google Places API ÏÇ¨Ïö© Ïó¨Î∂Ä ÏÑ†ÌÉù
        const USE_GOOGLE_PLACES_API = true // Google Places API ÌôúÏÑ±Ìôî!

        if (USE_GOOGLE_PLACES_API) {
          // Google Places API ÏÇ¨Ïö© Ïãú
          if (
            !data.googleApiKey ||
            data.googleApiKey === 'your-google-api-key-here' ||
            data.googleApiKey.includes('#') ||
            data.googleApiKey.length < 20
          ) {
            throw new Error('Google API key not properly configured in backend')
          }
          setGoogleApiKey(data.googleApiKey)
          console.log('Google Places API ÌôúÏÑ±Ìôî - API ÌÇ§ ÏÑ§Ï†ï ÏôÑÎ£å')
        } else {
          // Î°úÏª¨ ÏûêÎèôÏôÑÏÑ±Îßå ÏÇ¨Ïö©
          console.log('Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± Î™®Îìú ÏÇ¨Ïö© - Google Places API ÎπÑÌôúÏÑ±Ìôî')
          setApiKeyError(
            'Google API ÌÇ§ Î¨∏Ï†úÎ°ú Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö© Ï§ë (InvalidKeyMapError)',
          )
        }
      } catch (error) {
        console.error('Error fetching Google API key:', error)
        setApiKeyError(error.message)
        console.log('Falling back to local autocomplete mode')
      } finally {
        setIsLoadingApiKey(false)
      }
    }

    fetchGoogleApiKey()
  }, [])

  // Google Maps API ÏóêÎü¨ Í∞êÏßÄ Î∞è Ï≤òÎ¶¨
  useEffect(() => {
    // Ï†ÑÏó≠ Google Maps ÏóêÎü¨ Ìï∏Îì§Îü¨
    window.gm_authFailure = () => {
      console.error(
        'Google Maps authentication failed - switching to local autocomplete',
      )
      setApiKeyError('Google Maps Ïù∏Ï¶ù Ïã§Ìå® - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ±ÏúºÎ°ú Ï†ÑÌôòÎê®')
      setIsGoogleApiLoaded(false)
      setGoogleApiKey(null) // Google API ÌÇ§Î•º nullÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Îçî Ïù¥ÏÉÅ Î°úÎìúÌïòÏßÄ ÏïäÏùå
    }

    // InvalidKeyMapError Îì± Í∏∞ÌÉÄ ÏóêÎü¨ Í∞êÏßÄ
    const originalConsoleError = console.error
    console.error = (...args) => {
      const errorMessage = args.join(' ')
      if (
        errorMessage.includes('InvalidKeyMapError') ||
        errorMessage.includes('Google Maps JavaScript API error') ||
        errorMessage.includes('Google Maps API error')
      ) {
        console.log(
          'Google Maps API error detected - permanently switching to local autocomplete',
        )
        setApiKeyError('Google Maps API ÌÇ§ Ïò§Î•ò - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ±ÏúºÎ°ú Ï†ÑÌôòÎê®')
        setIsGoogleApiLoaded(false)
        setGoogleApiKey(null) // Google API ÌÇ§Î•º nullÎ°ú ÏÑ§Ï†ï

        // Ìñ•ÌõÑ Google API Î°úÎìú ÏãúÎèÑÎ•º Î∞©ÏßÄÌïòÍ∏∞ ÏúÑÌï¥ USE_GOOGLE_PLACES_APIÎ•º falseÎ°ú Î≥ÄÍ≤Ω
        // Ïù¥Îäî Îü∞ÌÉÄÏûÑÏóêÏÑúÎßå Ï†ÅÏö©ÎêòÎ©∞ ÏΩîÎìúÎäî Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏùå
      }
      originalConsoleError.apply(console, args)
    }

    return () => {
      delete window.gm_authFailure
      console.error = originalConsoleError
    }
  }, [])

  // Google Places API Î°úÎìú Î∞è ÏûêÎèôÏôÑÏÑ± ÏÑ§Ï†ï
  useEffect(() => {
    if (!googleApiKey || !inputRef.current || isGoogleApiLoaded || apiKeyError)
      return

    console.log(
      'Loading Google Places API with key:',
      googleApiKey.substring(0, 10) + '...',
    )

    // API ÌÇ§ Í∏∏Ïù¥ Ïû¨Í≤ÄÏ¶ù
    if (googleApiKey.length < 20) {
      console.error(
        'Google API key too short - switching to local autocomplete',
      )
      setApiKeyError('Google API ÌÇ§Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö©')
      return
    }

    const loader = new Loader({
      apiKey: googleApiKey,
      libraries: ['places'],
      language: 'ko',
      region: 'KR',
    })

    loader
      .load()
      .then(() => {
        console.log('Google Places API loaded successfully')
        if (inputRef.current && window.google?.maps?.places) {
          try {
            // ÏûêÎèôÏôÑÏÑ± ÏòµÏÖò ÏÑ§Ï†ï
            const options = {
              // types Ï†úÍ±∞ - Î™®Îì† ÌÉÄÏûÖÏùò Ïû•ÏÜå Í≤ÄÏÉâ ÌóàÏö© (ÏßÄÏó≠, Í¥ÄÍ¥ëÏßÄ, Í±¥Î¨º Îì±)
              componentRestrictions: { country: 'kr' }, // ÌïúÍµ≠ ÏßÄÏó≠ Ïö∞ÏÑ†
              fields: [
                'place_id',
                'name',
                'formatted_address',
                'geometry',
                'types',
                'photos',
              ],
            }

            autocompleteRef.current =
              new window.google.maps.places.Autocomplete(
                inputRef.current,
                options,
              )

            // ÏûêÎèôÏôÑÏÑ± ÎìúÎ°≠Îã§Ïö¥ Ïä§ÌÉÄÏùºÎßÅ Í∞úÏÑ†
            setTimeout(() => {
              const pacContainer = document.querySelector('.pac-container')
              if (pacContainer) {
                pacContainer.style.zIndex = '9999'
                pacContainer.style.fontSize = '14px'
                pacContainer.style.fontFamily = 'inherit'
              }
            }, 100)

            // Ïû•ÏÜå ÏÑ†ÌÉù Ïãú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            autocompleteRef.current.addListener('place_changed', () => {
              const place = autocompleteRef.current.getPlace()
              console.log('Place selected from Google:', place)

              if (place && (place.geometry || place.formatted_address)) {
                // ÏÑ†ÌÉùÎêú Ïû•ÏÜå Ï†ïÎ≥¥Î•º stateÏóê Ï†ÄÏû•
                const destinationValue =
                  place.formatted_address || place.name || ''

                setFormData((prev) => ({
                  ...prev,
                  destination: destinationValue,
                }))

                console.log('Selected place details:', {
                  name: place.name,
                  formatted_address: place.formatted_address,
                  place_id: place.place_id,
                  types: place.types,
                })

                setShowSuggestions(false)
              }
            })

            setIsGoogleApiLoaded(true)
            console.log('Google Places Autocomplete initialized successfully')
          } catch (initError) {
            console.error(
              'Error initializing Google Places Autocomplete:',
              initError,
            )
            setApiKeyError('Google Places Ï¥àÍ∏∞Ìôî Ïã§Ìå® - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö©')
            setGoogleApiKey(null)
          }
        } else {
          console.error('Google Maps Places library not available')
          setApiKeyError(
            'Google Maps Places library not loaded - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö©',
          )
          setGoogleApiKey(null)
        }
      })
      .catch((error) => {
        console.error('Error loading Google Maps API:', error)
        if (error.message.includes('ApiNotActivatedMapError')) {
          setApiKeyError(
            'Google Places APIÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏßÄ ÏïäÏùå - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö©',
          )
        } else if (error.message.includes('InvalidKeyMapError')) {
          setApiKeyError('Google API ÌÇ§ Ïò§Î•ò - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö©')
        } else {
          setApiKeyError(`Google Maps API Î°úÎìú Ïã§Ìå® - Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö©`)
        }
        setGoogleApiKey(null) // Google API ÌÇ§Î•º nullÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Ïû¨ÏãúÎèÑ Î∞©ÏßÄ
      })

    // Ï†ïÎ¶¨ Ìï®Ïàò
    return () => {
      if (autocompleteRef.current && window.google) {
        window.google.maps.event.clearInstanceListeners(autocompleteRef.current)
      }
    }
  }, [googleApiKey, isGoogleApiLoaded, apiKeyError])

  // CSS Ïä§ÌÉÄÏùºÏùÑ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÌïòÏó¨ Google Places ÏûêÎèôÏôÑÏÑ± Ïä§ÌÉÄÏùºÎßÅ
  useEffect(() => {
    const style = document.createElement('style')
    style.textContent = `
      .pac-container {
        background-color: white !important;
        border: 1px solid #d1d5db !important;
        border-radius: 0.5rem !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        font-family: inherit !important;
        font-size: 14px !important;
        z-index: 9999 !important;
        margin-top: 4px !important;
      }
      .pac-item {
        padding: 8px 12px !important;
        border-bottom: 1px solid #f3f4f6 !important;
        cursor: pointer !important;
      }
      .pac-item:hover {
        background-color: #f9fafb !important;
      }
      .pac-item-selected {
        background-color: #eff6ff !important;
      }
      .pac-matched {
        font-weight: 600 !important;
      }
      .pac-item-query {
        color: #1f2937 !important;
      }
    `
    document.head.appendChild(style)

    return () => {
      document.head.removeChild(style)
    }
  }, [])

  // Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± Í∏∞Îä• (Google API ÎåÄÏïà)
  const handleLocalAutocomplete = (query) => {
    console.log('Triggering local autocomplete for:', query)
    if (!query.trim()) {
      setSuggestions([])
      setShowSuggestions(false)
      return
    }

    const filtered = POPULAR_DESTINATIONS.filter(
      (dest) =>
        dest.name.toLowerCase().includes(query.toLowerCase()) ||
        dest.fullName.toLowerCase().includes(query.toLowerCase()) ||
        dest.description.toLowerCase().includes(query.toLowerCase()),
    )

    console.log('Local autocomplete results:', filtered.length)
    setSuggestions(filtered.slice(0, 5)) // ÏµúÎåÄ 5Í∞ú Í≤∞Í≥º
    setShowSuggestions(true)
  }

  // ÏûÖÎ†• Î≥ÄÍ≤Ω Ï≤òÎ¶¨
  const handleDestinationChange = (value) => {
    console.log('Destination input changed:', value)
    setFormData((prev) => ({ ...prev, destination: value }))

    // Google APIÍ∞Ä ÏóÜÍ±∞ÎÇò Ïã§Ìå®Ìïú Í≤ΩÏö∞ Ìï≠ÏÉÅ Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± ÏÇ¨Ïö©
    if (!isGoogleApiLoaded || apiKeyError) {
      console.log('Using local autocomplete (Google API not available)')
      handleLocalAutocomplete(value)
    }
  }

  // Ï†úÏïà Ìï≠Î™© ÏÑ†ÌÉù
  const handleSuggestionSelect = (suggestion) => {
    console.log('Local suggestion selected:', suggestion)
    setFormData((prev) => ({ ...prev, destination: suggestion.fullName }))
    setShowSuggestions(false)
    setSuggestions([])
  }

  // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Ï†úÏïà Î™©Î°ù Ïà®Í∏∞Í∏∞
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (inputRef.current && !inputRef.current.contains(event.target)) {
        setShowSuggestions(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  const handleInputChange = (field, value) => {
    if (field === 'destination') {
      handleDestinationChange(value)
    } else {
      setFormData((prev) => ({
        ...prev,
        [field]: value,
      }))

      // ÎÇ†Ïßú ÏÑ†ÌÉù Ïãú Ìï¥Îãπ Îã¨Î†• Îã´Í∏∞
      if (field === 'startDate') {
        setStartDateOpen(false)
      } else if (field === 'endDate') {
        setEndDateOpen(false)
      }
    }
  }

  const handleThemeSelect = (themeId) => {
    setFormData((prev) => ({
      ...prev,
      theme: prev.theme === themeId ? '' : themeId,
    }))
  }

  const handleWeatherConditionToggle = (conditionId) => {
    setFormData((prev) => ({
      ...prev,
      weatherConditions: prev.weatherConditions.includes(conditionId)
        ? prev.weatherConditions.filter((id) => id !== conditionId)
        : [...prev.weatherConditions, conditionId],
    }))
  }

  const handleSubmit = (e) => {
    e.preventDefault()
    if (formData.destination && formData.startDate && formData.endDate) {
      onSubmit(formData)
    }
  }

  const isFormValid =
    formData.destination && formData.startDate && formData.endDate

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Ïó¨ÌñâÏßÄ ÏûÖÎ†• */}
      <div className="space-y-2">
        <Label htmlFor="destination" className="flex items-center gap-2">
          <MapPin className="h-4 w-4" />
          Ïó¨ÌñâÏßÄ
          {isLoadingApiKey && (
            <span className="text-xs text-blue-600">
              üîÑ ÏûêÎèôÏôÑÏÑ± Î°úÎî© Ï§ë...
            </span>
          )}
          {!isLoadingApiKey && isGoogleApiLoaded && (
            <span className="text-xs text-green-600">
              ‚úÖ Google Places ÌôúÏÑ±Ìôî
            </span>
          )}
          {apiKeyError && !isLoadingApiKey && (
            <span className="text-xs text-orange-600">üîç Î°úÏª¨ Í≤ÄÏÉâ Î™®Îìú</span>
          )}
        </Label>

        <div className="relative">
          <Input
            id="destination"
            placeholder="Ïó¨ÌñâÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (Ïòà: Î∂ÄÏÇ∞, Ï†úÏ£ºÎèÑ, Í∞ïÎ¶â, Í≤ΩÎ≥µÍ∂Å)"
            value={formData.destination}
            onChange={(e) => handleInputChange('destination', e.target.value)}
            className="w-full"
            ref={inputRef}
            disabled={isLoadingApiKey}
            onFocus={() => {
              console.log('Input focused manually')
              if (!isGoogleApiLoaded && formData.destination) {
                handleLocalAutocomplete(formData.destination)
              }
            }}
          />

          {/* Î°úÏª¨ ÏûêÎèôÏôÑÏÑ± Î™©Î°ù */}
          {showSuggestions &&
            suggestions.length > 0 &&
            (!isGoogleApiLoaded || apiKeyError) && (
              <div className="absolute top-full right-0 left-0 z-50 mt-1 max-h-60 overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-lg">
                {suggestions.map((suggestion, index) => (
                  <div
                    key={index}
                    className="cursor-pointer border-b border-gray-100 p-3 last:border-b-0 hover:bg-blue-50"
                    onClick={() => handleSuggestionSelect(suggestion)}
                  >
                    <div className="font-medium text-gray-900">
                      {suggestion.fullName}
                    </div>
                    <div className="text-sm text-gray-600">
                      {suggestion.description}
                    </div>
                  </div>
                ))}
              </div>
            )}

          {/* ÏûêÎèôÏôÑÏÑ± ÏÉÅÌÉú ÌëúÏãú */}
          {showSuggestions && isGoogleApiLoaded && (
            <div className="mt-1 text-xs text-blue-600">
              üí° ÏûÖÎ†•ÌïòÏãúÎ©¥ Google Places ÏûêÎèôÏôÑÏÑ± Î™©Î°ùÏù¥ ÏïÑÎûòÏóê ÎÇòÌÉÄÎÇ©ÎãàÎã§
            </div>
          )}

          {showSuggestions &&
            suggestions.length > 0 &&
            (!isGoogleApiLoaded || apiKeyError) && (
              <div className="mt-1 text-xs text-orange-600">
                üí° Ïù∏Í∏∞ Ïó¨ÌñâÏßÄÏóêÏÑú Í≤ÄÏÉâ Ï§ëÏûÖÎãàÎã§
              </div>
            )}
        </div>

        {/* API ÌÇ§ Ïò§Î•ò ÌëúÏãú */}
        {apiKeyError && (
          <div className="mt-2 rounded-md border border-orange-200 bg-orange-50 p-3">
            <p className="text-sm text-orange-700">
              <strong>Google Places API ÏÇ¨Ïö© Î∂àÍ∞Ä:</strong> {apiKeyError}
            </p>
            <p className="mt-1 text-xs text-orange-600">
              üí° ÌòÑÏû¨ ÌïúÍµ≠ Ï£ºÏöî Ïó¨ÌñâÏßÄ Î™©Î°ùÏóêÏÑú Í≤ÄÏÉâÌï©ÎãàÎã§. Google API ÌÇ§Î•º
              ÏÑ§Ï†ïÌïòÎ©¥ Îçî Ï†ïÌôïÌïú ÏûêÎèôÏôÑÏÑ±ÏùÑ Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.
            </p>
          </div>
        )}

        <div className="space-y-1 text-xs text-gray-500">
          <p>üí° ÏßÄÏó≠Î™ÖÏù¥ÎÇò Í¥ÄÍ¥ëÏßÄÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÎ©¥ ÏûêÎèôÏôÑÏÑ± Î™©Î°ùÏù¥ ÎÇòÌÉÄÎÇ©ÎãàÎã§</p>
          <p>
            üîç ÏòàÏãú: &quot;Î∂ÄÏÇ∞ Ìï¥Ïö¥ÎåÄ&quot;, &quot;Ï†úÏ£ºÎèÑ&quot;,
            &quot;Í≤ΩÎ≥µÍ∂Å&quot;, &quot;Í∞ïÎ¶â Î∞îÎã§&quot; Îì±
          </p>
          {(!isGoogleApiLoaded || apiKeyError) && (
            <p className="text-orange-600">
              üìç ÌòÑÏû¨ {POPULAR_DESTINATIONS.length}Í∞ú Ïù∏Í∏∞ Ïó¨ÌñâÏßÄÏóêÏÑú Í≤ÄÏÉâÌï©ÎãàÎã§
            </p>
          )}
        </div>
      </div>

      {/* ÎÇ†Ïßú ÏÑ†ÌÉù */}
      <div className="space-y-2">
        <Label>üìÖ Ïó¨Ìñâ Í∏∞Í∞Ñ</Label>
        <div className="flex flex-col gap-4 sm:flex-row">
          <div className="flex-1">
            <Label htmlFor="startDate" className="text-sm text-gray-600">
              Ï∂úÎ∞úÏùº
            </Label>
            <Popover open={startDateOpen} onOpenChange={setStartDateOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className="w-full justify-start text-left font-normal"
                >
                  <CalendarIcon className="mr-2 h-4 w-4" />
                  {formData.startDate ? (
                    format(formData.startDate, 'PPP', { locale: ko })
                  ) : (
                    <span>Ï∂úÎ∞úÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
                  )}
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-auto p-0" align="start">
                <Calendar
                  mode="single"
                  selected={formData.startDate}
                  onSelect={(date) => handleInputChange('startDate', date)}
                  initialFocus
                  disabled={(date) => {
                    const today = new Date()
                    today.setHours(0, 0, 0, 0)
                    const selectedDate = new Date(date)
                    selectedDate.setHours(0, 0, 0, 0)

                    // Ïò§ÎäòÎ≥¥Îã§ Ïù¥Ï†Ñ ÎÇ†ÏßúÎäî ÏÑ†ÌÉù Î∂àÍ∞Ä
                    return selectedDate < today
                  }}
                />
              </PopoverContent>
            </Popover>
          </div>

          <div className="flex-1">
            <Label htmlFor="endDate" className="text-sm text-gray-600">
              ÎèÑÏ∞©Ïùº
            </Label>
            <Popover open={endDateOpen} onOpenChange={setEndDateOpen}>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className="w-full justify-start text-left font-normal"
                >
                  <CalendarIcon className="mr-2 h-4 w-4" />
                  {formData.endDate ? (
                    format(formData.endDate, 'PPP', { locale: ko })
                  ) : (
                    <span>ÎèÑÏ∞©ÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</span>
                  )}
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-auto p-0" align="start">
                <Calendar
                  mode="single"
                  selected={formData.endDate}
                  onSelect={(date) => handleInputChange('endDate', date)}
                  initialFocus
                  disabled={(date) => {
                    const today = new Date()
                    today.setHours(0, 0, 0, 0)

                    // Ïò§ÎäòÎ≥¥Îã§ Ïù¥Ï†Ñ ÎÇ†ÏßúÎäî ÏÑ†ÌÉù Î∂àÍ∞Ä
                    if (date < today) return true

                    // Ï∂úÎ∞úÏùºÏù¥ ÏÑ†ÌÉùÎêú Í≤ΩÏö∞, Ï∂úÎ∞úÏùºÎ≥¥Îã§ Ïù¥Ï†Ñ ÎÇ†ÏßúÎäî ÏÑ†ÌÉù Î∂àÍ∞Ä
                    if (formData.startDate) {
                      const startDate = new Date(formData.startDate)
                      startDate.setHours(0, 0, 0, 0)
                      const selectedDate = new Date(date)
                      selectedDate.setHours(0, 0, 0, 0)

                      return selectedDate < startDate
                    }

                    return false
                  }}
                />
              </PopoverContent>
            </Popover>
          </div>
        </div>
      </div>

      {/* ÌÖåÎßà ÏÑ†ÌÉù */}
      <div className="space-y-2">
        <Label>üéØ ÌÖåÎßà ÏÑ†ÌÉù (ÏÑ†ÌÉùÏÇ¨Ìï≠)</Label>
        <div className="flex flex-wrap gap-2">
          {themes.map((theme) => (
            <Badge
              key={theme.id}
              variant={formData.theme === theme.id ? 'default' : 'outline'}
              className={`cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 ${
                formData.theme === theme.id
                  ? 'bg-blue-600 text-white'
                  : 'bg-white dark:bg-gray-800'
              }`}
              onClick={() => handleThemeSelect(theme.id)}
            >
              {theme.icon} {theme.label}
            </Badge>
          ))}
        </div>
      </div>

      {/* ÎÇ†Ïî® Í≥†Î†§ Ï°∞Í±¥ */}
      <div className="space-y-2">
        <Label>üåÄ ÎÇ†Ïî® Í≥†Î†§ Ï°∞Í±¥ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</Label>
        <div className="space-y-2">
          {weatherConditions.map((condition) => (
            <div key={condition.id} className="flex items-center space-x-2">
              <Checkbox
                id={condition.id}
                checked={formData.weatherConditions.includes(condition.id)}
                onCheckedChange={() =>
                  handleWeatherConditionToggle(condition.id)
                }
              />
              <Label
                htmlFor={condition.id}
                className="cursor-pointer text-sm font-normal"
              >
                {condition.label}
              </Label>
            </div>
          ))}
        </div>
      </div>

      {/* Ï†úÏ∂ú Î≤ÑÌäº */}
      <Button
        type="submit"
        className="w-full bg-blue-600 text-white hover:bg-blue-700"
        disabled={!isFormValid}
      >
        üìã Ïó¨Ìñâ ÌîåÎûú ÏÉùÏÑ±ÌïòÍ∏∞
      </Button>
    </form>
  )
}
